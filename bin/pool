#!/usr/bin/ruby
require 'rubygems'
$:.unshift(File.join(File.dirname(__FILE__), "lib"))
require 'lib/poolparty'

# Set defaults
options = PoolParty.options(:optsparse => 
  {:banner => <<-EOU
Usage: pool [OPTIONS] {start | stop | list | maintain | restart}
-----------------------------------------------------------------
    EOU
    })
master = PoolParty::Master.new
list = PoolParty::Optioner.parse(ARGV.dup, %w(-v))

case list[0]
when "start"
  PoolParty.message <<-EOM
Starting #{PoolParty::Application.app_name ? "#{PoolParty::Application.app_name} " : "" }cloud
  On #{PoolParty::Application.ami}
  Minimum instances: #{PoolParty::Application.minimum_instances}
  Maximum instances: #{PoolParty::Application.maximum_instances}
  Polling every: #{PoolParty::Application.polling_time}
  
  EOM
  master.start_cloud!
when "stop"
  PoolParty.message "Stopping cloud"
  master.request_termination_of_all_instances  
when "list"
  puts master.list
when "maintain"
  PoolParty.message "Maintaining cloud"
  master.start_monitor!
when "restart"
  PoolParty.message "Restarting cloud"
  master.request_termination_of_all_instances
  master.start_cloud!
else
  puts master.list
end