#!/usr/bin/ruby
require 'rubygems'
require 'optparse'
require 'poolparty'
require "fileutils"

# Set defaults
commandables = %w(ssh cmd scp restart start stop install start_maintain stop_maintain)
options = PoolParty.options(:optsparse => 
  { :banner => <<-EOU
Usage: instance [OPTIONS] { #{commandables.join(" | ")} }
-----------------------------------------------------------------
    EOU
    })
PoolParty.load_plugins
master = PoolParty::Master.new
list = PoolParty::Optioner.parse(ARGV.dup, %w(-v))
num = list.reject {|a| commandables.include?(a) }.pop

instance = master.get_node(num)

unless instance
  puts "Cloud is not running"
  exit
end

case list[0]
when "ssh"
  PoolParty.message "Ssh'ing into #{instance.ip}"
  instance.ssh
when "cmd"
  PoolParty.message "Executing #{instance_options[:cmd]} on #{instance.ip}"
  instance.ssh instance_options[:cmd]
when "scp"
  instance.scp instance_options[:src], instance_options[:dest]
when "restart"
  message "Restarting services"
  instance.restart_with_monit
when "start"
  message "Starting services"
  instance.start_with_monit
when "stop"
  message "Stopping services"
  instance.stop_with_monit
when "install"
  message "Installing services"
  instance.install
when "start_maintain"
  message "Running heartbeat failover service"
  pid = Master.run_thread_loop(:daemonize => true) do
    instance.become_master if instance.is_not_master_and_master_is_not_running?
  end
  File.open(Application.maintain_pid_path) {|f| f.write(pid)}
when "stop_maintain"
  message "Stopping heartbeat failover service"
  pid = open(Application.maintain_pid_path).read
  `kill -9 #{pid}`
  FileUtils.rm Application.maintain_pid_path # Check this
else
  puts master.list
end